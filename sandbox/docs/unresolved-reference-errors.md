# Unresolved reference errors

I initially discovered issues with vcpkg and cmake, I couldn't link wxwidgets.

Today I wanted to add googletest library and discovered that I can't link it due to undefined reference errors.

```powershell
C:/msys64/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/12.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: CMakeFiles/main.dir/test/main.cpp.obj:main.cpp:(.text+0x3e): undefined reference to `testing::internal::CmpHelperSTRNE(char const*, char const*, char const*, char const*)'
C:/msys64/mingw64/bin/../lib/gcc/x86_64-w64-mingw32/12.1.0/../../../../x86_64-w64-mingw32/bin/ld.exe: CMakeFiles/main.dir/test/main.cpp.obj:main.cpp:(.text$_ZN30HelloTest_BasicAssertions_TestC1Ev[_ZN30HelloTest_BasicAssertions_TestC1Ev]+0x14): undefined reference to `testing::Test::Test()'
```

## Isolate the issue

### Link the library manually against built googletest inside cmake build directory

```powershell
g++ main.cpp -IC:/Users/Srecko/Documents/MyProjects/Private/container-sk-experiments/sk-experiments/cpp/experiments/algorithms/build/vcpkg_installed/x64-windows/include -LC:/Users/Srecko/Documents/MyProjects/Private/container-sk-experiments/sk-experiments/cpp/experiments/algorithms/build/vcpkg_installed/x64-windows/debug/lib/manual-link -LC:/Users/Srecko/Documents/MyProjects/Private/container-sk-experiments/sk-experiments/cpp/experiments/algorithms/build/vcpkg_installed/x64-windows/debug/lib -lgtest -lgtest_main -lgmock -lgmock_main -o main.exe
```

### Link the library manually inside vcpkg directory

```powershell
clang++ -std=c++17 main.cpp -o main -IC:\src\vcpkg\installed\x64-windows\include -LC:/Users/Srecko/Documents/MyProjects/Private/container-sk-experiments/sk-experiments/cpp/experiments/algorithms/build/vcpkg_installed/x64-windows/debug/lib/manual-link -LC:\src\vcpkg\installed\x64-windows\debug\lib -lgmock -lgmock_main -lgtest -lgtest_main
```

### Inspect symbols using `dumpbin` since linker can't find symbols...

1. Inspect symbols on all previous locations
2. Inspect symbols of manually built gtest library

### Manually build library, link again it, and inspect symbols

```powershell
clang++ -std=c++17 main.cpp -o main -IC:\libs\googletest\googletest\include -LC:\libs\googletest\build\lib -lgtest -lgtest_main
```

## What I tried

I tried to manually compile the following file:

```cpp
#include "gtest/gtest.h"

// Demonstrate some basic assertions.
TEST(HelloTest, BasicAssertions) {
  // Expect two strings not to be equal.
  EXPECT_STRNE("hello", "world");
  // Expect equality.
  EXPECT_EQ(7 * 6, 42);
}
```

Using:

```powershell
clang++ -std=c++17 main.cpp -o main -IC:\src\vcpkg\installed\x64-windows\include -LC:\src\vcpkg\installed\x64-windows\debug\lib\manual-link -LC:\src\vcpkg\installed\x64-windows\debug\lib -lgtest -lgtest_main -v
```

I also tried to manually compile it against gtest and gtest_main located in directory generated by CMake, same error.

```txt
C:\Users\Srecko\Documents\MyProjects\Private\container-sk-experiments\sk-experiments\cpp\experiments\algorithms\build\vcpkg_installed\x64-windows\debug\lib\manual-link

C:\Users\Srecko\Documents\MyProjects\Private\container-sk-experiments\sk-experiments\cpp\experiments\algorithms\build\vcpkg_installed\x64-windows\debug\lib
```

## Inspect symbols of a binary

[Inspect symbols](https://learn.microsoft.com/en-us/cpp/build/building-on-the-command-line?view=msvc-170#developer_command_prompt)

For example:

```cmd
C:\src\vcpkg\installed\x64-windows\debug\lib>dumpbin /symbols gtest.lib
Microsoft (R) COFF/PE Dumper Version 14.36.32532.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file gtest.lib

File Type: LIBRARY

COFF SYMBOL TABLE
000 01017F14 ABS    notype       Static       | @comp.id
001 00000000 SECT2  notype       External     | __IMPORT_DESCRIPTOR_gtest
002 C0000040 SECT2  notype       Section      | .idata$2
003 00000000 SECT3  notype       Static       | .idata$6
004 C0000040 UNDEF  notype       Section      | .idata$4
005 C0000040 UNDEF  notype       Section      | .idata$5
006 00000000 UNDEF  notype       External     | __NULL_IMPORT_DESCRIPTOR
007 00000000 UNDEF  notype       External     | gtest_NULL_THUNK_DATA

String Table Size = 0x4E bytes

COFF SYMBOL TABLE
000 01017F14 ABS    notype       Static       | @comp.id
001 00000000 SECT2  notype       External     | __NULL_IMPORT_DESCRIPTOR

String Table Size = 0x1D bytes

COFF SYMBOL TABLE
000 01017F14 ABS    notype       Static       | @comp.id
001 00000000 SECT2  notype       External     | gtest_NULL_THUNK_DATA

String Table Size = 0x1B bytes

  Summary

          BD .debug$S
          14 .idata$2
          14 .idata$3
           8 .idata$4
           8 .idata$5
           A .idata$6
```

```cmd
C:\src\vcpkg\installed\x64-windows\debug\lib\manual-link>dumpbin /symbols gtest_main.lib
Microsoft (R) COFF/PE Dumper Version 14.36.32532.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file gtest_main.lib

File Type: LIBRARY

COFF SYMBOL TABLE
000 01017F14 ABS    notype       Static       | @comp.id
001 00000000 SECT2  notype       External     | __IMPORT_DESCRIPTOR_gtest_main
002 C0000040 SECT2  notype       Section      | .idata$2
003 00000000 SECT3  notype       Static       | .idata$6
004 C0000040 UNDEF  notype       Section      | .idata$4
005 C0000040 UNDEF  notype       Section      | .idata$5
006 00000000 UNDEF  notype       External     | __NULL_IMPORT_DESCRIPTOR
007 00000000 UNDEF  notype       External     | gtest_main_NULL_THUNK_DATA

String Table Size = 0x58 bytes

COFF SYMBOL TABLE
000 01017F14 ABS    notype       Static       | @comp.id
001 00000000 SECT2  notype       External     | __NULL_IMPORT_DESCRIPTOR

String Table Size = 0x1D bytes

COFF SYMBOL TABLE
000 01017F14 ABS    notype       Static       | @comp.id
001 00000000 SECT2  notype       External     | gtest_main_NULL_THUNK_DATA

String Table Size = 0x20 bytes

  Summary

          CC .debug$S
          14 .idata$2
          14 .idata$3
           8 .idata$4
           8 .idata$5
          10 .idata$6
```

ChatGPT said that:

It appears that the gtest.lib file you've inspected doesn't contain the symbols you're expecting for the Google Test framework. It's mostly composed of import descriptors and other metadata, without the actual function symbols.

It's clear from both dumpbin outputs that the gtest.lib and gtest_main.lib files do not contain the expected symbols. These files look like import libraries rather than the actual static libraries containing the Google Test code. This could explain why you're encountering undefined reference errors during linking.

And for `dll`:

```cmd
C:\src\vcpkg\installed\x64-windows\debug\bin>dumpbin /symbols gtest.dll
Microsoft (R) COFF/PE Dumper Version 14.36.32532.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file gtest.dll

File Type: DLL

  Summary

        1000 .00cfg
        3000 .data
        4000 .idata
       13000 .pdata
       46000 .rdata
        2000 .reloc
        1000 .rsrc
       CA000 .text
        1000 .tls

C:\src\vcpkg\installed\x64-windows\debug\bin>dumpbin /symbols gtest_main.dll
Microsoft (R) COFF/PE Dumper Version 14.36.32532.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file gtest_main.dll

File Type: DLL

  Summary

        1000 .00cfg
        2000 .data
        3000 .idata
        3000 .pdata
        F000 .rdata
        1000 .reloc
        1000 .rsrc
       1D000 .text
```

## Success

Manual build yielded results. I was able to run the tests.

Dumpbin of manualy built gtest library displayed many symbols:

```cmd
C:\libs\googletest\build\lib>dumpbin /symbols libgmock.a
```

Manual build of `googletest` worked, documentation is [here](https://github.com/google/googletest/blob/main/googletest/README.md#build-with-cmake).

Manual compilation command:

```powershell
PS C:\Users\Srecko\Documents\MyProjects\Private\container-sk-experiments\sk-experiments\cpp\experiments\algorithms\test> clang++ -std=c++17 main.cpp -o main -IC:\libs\googletest\googletest\include -LC:\libs\googletest\build\lib -lgtest -lgtest_main -v
```

Output of the running tests:

```powershell
PS C:\Users\Srecko\Documents\MyProjects\Private\container-sk-experiments\sk-experiments\cpp\experiments\algorithms\test> ./main
Running main() from C:/libs/googletest/googletest/src/gtest_main.cc
[==========] Running 1 test from 1 test suite.
[----------] Global test environment set-up.
[----------] 1 test from HelloTest
[ RUN      ] HelloTest.BasicAssertions
[       OK ] HelloTest.BasicAssertions (0 ms)
[----------] 1 test from HelloTest (2 ms total)

[----------] Global test environment tear-down
[==========] 1 test from 1 test suite ran. (9 ms total)
[  PASSED  ] 1 test.
```
