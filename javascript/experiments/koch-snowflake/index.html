<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Koch Snowflake</title>
    <style>
      canvas {
        border: 1px solid black;
      }

      .config {
        width: max-content;
        display: flex;
        flex-direction: column;
      }

      .config__control {
        display: flex;
        justify-content: space-between;
        margin-bottom: 5px;
      }

      .config__input {
        margin-left: 5px;
      }
    </style>
  </head>
  <body>
    <div class="config">
      <label class="config__control" for="x">
        x
        <input
          class="config__input"
          type="number"
          id="x"
          name="x"
          data-value="50"
        />
      </label>

      <label class="config__control" for="y">
        y
        <input
          class="config__input"
          type="number"
          id="y"
          name="y"
          data-value="350"
        />
      </label>

      <label class="config__control" for="angle">
        angle
        <input
          class="config__input"
          type="number"
          id="angle"
          name="angle"
          data-value="60"
        />
      </label>

      <label class="config__control" for="canvasWidth">
        canvasWidth
        <input
          class="config__input"
          type="number"
          id="canvasWidth"
          name="canvasWidth"
          data-value="360"
        />
      </label>

      <label class="config__control" for="canvasHeight">
        canvasHeight
        <input
          class="config__input"
          type="number"
          name="canvasHeight"
          id="canvasHeight"
          data-value="360"
        />
      </label>

      <label class="config__control" for="level">
        level
        <input
          class="config__input"
          type="number"
          name="level"
          id="level"
          data-value="3"
        />
      </label>
    </div>
  </body>

  <script>
    (() => {
      'use strict';
      console.clear();

      class Point {
        constructor(properties) {
          this.x = properties.x;
          this.y = properties.y;
        }
      }

      class Geometry {
        static GetRadians(degrees) {
          return (Math.PI / 180) * degrees;
        }

        static GetDestinationPoint({ from, direction, angle }) {
          return new Point({
            x: from.x + Math.cos(Geometry.GetRadians(angle)) * direction,
            y: from.y + Math.sin(Geometry.GetRadians(angle)) * direction,
          });
        }
      }

      class KochSnowflakeWindow {
        id = Object.freeze('koch-snowflake-window');

        constructor({ width, height }) {
          this.width = width;
          this.height = height;

          this.canvas = document.createElement('canvas');
          this.ctx = this.canvas.getContext('2d');

          this.SetCanvasProperties();
          this.ShowCanvasOnce();
        }

        SetCanvasProperties() {
          this.canvas.width = this.width;
          this.canvas.height = this.height;
          this.canvas.id = this.id;
        }

        ShowCanvasOnce() {
          const canvasIsVisible = document.getElementById(this.id);
          if (!canvasIsVisible) {
            document.getElementsByTagName('body')[0].appendChild(this.canvas);
          }
        }

        Stroke() {
          this.ctx.stroke();
        }

        MoveTo(point) {
          this.ctx.moveTo(point.x, point.y);
        }

        LineTo(point) {
          this.ctx.lineTo(point.x, point.y);
        }
      }

      class KochSnowflake {
        constructor({ destination, lineLength, rotationAngle, windowSize }) {
          this.destination = destination;
          this.lineLength = lineLength;
          this.rotationAngle = rotationAngle;

          const initialAngle = 0;

          this.angle = initialAngle;
          // TODO: Decouple snowflake window. It is troublesome to use
          // KochSnowflake as proxy for configuration to KochSnowflakeWindow.
          this.kochSnowflakeWindow = new KochSnowflakeWindow(windowSize);
        }

        TurnLeft() {
          this.angle -= this.rotationAngle;
        }

        TurnRight() {
          this.angle += this.rotationAngle;
        }

        CalculateAndSaveDestination() {
          this.destination = Geometry.GetDestinationPoint({
            from: this.destination,
            direction: this.lineLength,
            angle: this.angle,
          });
        }

        DrawLine() {
          this.CalculateAndSaveDestination();
          this.kochSnowflakeWindow.LineTo(this.destination);
        }

        DrawSide(n) {
          if (n > 1) {
            this.DrawSide(n - 1);
            this.TurnLeft();
            this.DrawSide(n - 1);
            this.TurnRight();
            this.TurnRight();
            this.DrawSide(n - 1);
            this.TurnLeft();
            this.DrawSide(n - 1);
          } else {
            this.DrawLine();
          }
        }

        Draw(n) {
          this.kochSnowflakeWindow.MoveTo(this.destination);

          this.TurnLeft();
          this.DrawSide(n);
          this.TurnRight();
          this.TurnRight();
          this.DrawSide(n);
          this.TurnRight();
          this.TurnRight();
          this.DrawSide(n);

          this.kochSnowflakeWindow.Stroke();
        }
      }

      function drawKochSnowflake() {
        const x = 50;
        const y = 350;
        const lineLength = 20;
        const rotationAngle = 60;
        const initialDestination = new Point({ x, y });
        const kochSnowflake = new KochSnowflake({
          destination: initialDestination,
          lineLength,
          rotationAngle,
          windowSize: { width: 500, height: 500 },
        });

        kochSnowflake.Draw(3);
      }

      drawKochSnowflake();

      class ConfigurationControls {
        configuration = {};

        constructor() {
          this.configurationInputs =
            document.querySelectorAll('.config__input');
          this.event = 'input';

          this.SaveDefaultConfigurationValues();
          this.DrawKochSnowflake();
          this.SetupListeners();
        }

        SaveDefaultConfigurationValues = () => {
          this.configurationInputs.forEach((input) => {
            this.DisplayDefaultConfigurationValue(input);
            this.SaveDefaultConfigurationValue(input);
          });
        };

        DisplayDefaultConfigurationValue = (input) => {
          input.value = input.dataset.value;
        };

        SaveDefaultConfigurationValue = (input) => {
          this.SaveConfigurationValue({
            key: input.name,
            value: input.dataset.value,
          });
        };

        SetupListeners = () => {
          this.configurationInputs.forEach(this.SetupListener);
        };

        SetupListener = (input) => {
          input.addEventListener(this.event, (event) => {
            this.SaveConfigurationValue({
              key: event.target.name,
              value: event.target.value,
            });
            this.DrawKochSnowflake();
          });
        };

        SaveConfigurationValue = ({ key, value }) => {
          // TODO: Skip updating on non-numeric values. We don't know what the
          // user is going to put in.
          this.configuration[key] = parseInt(value);
        };

        DrawKochSnowflake = () => {
          console.log(this.configuration);
        };
      }

      new ConfigurationControls();
    })();
  </script>
</html>
